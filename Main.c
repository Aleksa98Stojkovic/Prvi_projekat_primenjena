/* 
 * File:   Main.c
 * Author: Aleksa Stojkovic(EE7/2017)
 *
 * Created on December 29, 2020, 10:45 PM
 */

#include<p30fxxxx.h>
#include <stdlib.h>
#include "driverGLCD.h"
#include "ADC.h"
#include "Tajmeri.h"
#include "UART.h"
#define PRAG 2047


//_FOSC(CSW_FSCM_OFF & XT_PLL4); // instruction takt je isti kao i kristal
_FOSC(CSW_ON_FSCM_OFF & HS3_PLL4);
_FWDT(WDT_OFF);
_FGS(CODE_PROT_OFF);


// ------------------------------------------------------  
// GLCD Picture name: blank.bmp            
// GLCD Model: KS0108 128x64            
// ------------------------------------------------------  

unsigned char const keypad[7][1024] = {{
 255,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,255, 
 255,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,255, 
 255,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  4,  2,254,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  4,  2, 
 130, 98, 28,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  4, 34, 34, 34,220,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255, 
 255,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8, 10,202, 43,234, 10,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,234, 43, 
  42, 42, 42,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,137, 74, 42, 42, 41,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255, 
 255,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128, 
 128,128,140,139,136,136,191,136,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,255,128,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,128,128,128,145,161, 
 161,161,158,128,128,128,128,128,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,255,128,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,128,128,159,162,162,162,156,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,255, 
 255,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  2,  2,  2,226, 26,  6,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,220, 34, 
  34, 34,220,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0, 28, 34, 34, 34,252,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255, 
 255,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,232, 40, 40, 40, 40, 
  72,136,  8,  8,235, 40, 40, 40, 40,  8,  8,232,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,201, 42, 
  42, 42,201,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8,  8,  8,  8,136,136, 
 136,136,136,136,136,136,136,136,138,138,234,233,232,200,200,200, 
 136,136,136,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255, 
 255,128,128,128,128,128,128,128,128,128,128,191,160,160,160,160, 
 144,143,128,128,191,162,162,162,160,128,128,191,160,160,160,160, 
 128,128,128,128,128,128,128,128,128,128,128,255,128,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,128,128,128,159,160, 
 160,160,159,128,128,128,128,128,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,255,128,128,128,128,128,128,128,143,143, 
 143,143,143,143,143,143,143,143,143,143,191,191,191,159,159,159, 
 143,143,143,135,135,135,130,130,128,128,128,128,128,128,128,255 
 },
{
 255,  1,  1,  1,  1,129,145,161,193,249,193,161,145,129,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,255, 
 255,192,192,192,192,192,196,194,193,207,193,194,196,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,255, 
 255,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  4,  2,254,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  4,  2, 
 130, 98, 28,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  4, 34, 34, 34,220,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255, 
 255,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8, 10,202, 43,234, 10,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,234, 43, 
  42, 42, 42,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,137, 74, 42, 42, 41,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255, 
 255,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128, 
 128,128,140,139,136,136,191,136,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,255,128,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,128,128,128,145,161, 
 161,161,158,128,128,128,128,128,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,255,128,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,128,128,159,162,162,162,156,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,255, 
 255,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  2,  2,  2,226, 26,  6,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,220, 34, 
  34, 34,220,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0, 28, 34, 34, 34,252,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255, 
 255,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,232, 40, 40, 40, 40, 
  72,136,  8,  8,235, 40, 40, 40, 40,  8,  8,232,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,201, 42, 
  42, 42,201,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8,  8,  8,  8,136,136, 
 136,136,136,136,136,136,136,136,138,138,234,233,232,200,200,200, 
 136,136,136,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255, 
 255,128,128,128,128,128,128,128,128,128,128,191,160,160,160,160, 
 144,143,128,128,191,162,162,162,160,128,128,191,160,160,160,160, 
 128,128,128,128,128,128,128,128,128,128,128,255,128,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,128,128,128,159,160, 
 160,160,159,128,128,128,128,128,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,255,128,128,128,128,128,128,128,143,143, 
 143,143,143,143,143,143,143,143,143,143,191,191,191,159,159,159, 
 143,143,143,135,135,135,130,130,128,128,128,128,128,128,128,255 
},
{
 255,  1,  1,  1,  1,129,145,161,193,249,193,161,145,129,  1,  1, 
   1,129,145,161,193,249,193,161,145,129,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,255, 
 255,192,192,192,192,192,196,194,193,207,193,194,196,192,192,192, 
 192,192,196,194,193,207,193,194,196,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,255, 
 255,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  4,  2,254,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  4,  2, 
 130, 98, 28,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  4, 34, 34, 34,220,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255, 
 255,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8, 10,202, 43,234, 10,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,234, 43, 
  42, 42, 42,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,137, 74, 42, 42, 41,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255, 
 255,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128, 
 128,128,140,139,136,136,191,136,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,255,128,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,128,128,128,145,161, 
 161,161,158,128,128,128,128,128,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,255,128,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,128,128,159,162,162,162,156,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,255, 
 255,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  2,  2,  2,226, 26,  6,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,220, 34, 
  34, 34,220,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0, 28, 34, 34, 34,252,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255, 
 255,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,232, 40, 40, 40, 40, 
  72,136,  8,  8,235, 40, 40, 40, 40,  8,  8,232,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,201, 42, 
  42, 42,201,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8,  8,  8,  8,136,136, 
 136,136,136,136,136,136,136,136,138,138,234,233,232,200,200,200, 
 136,136,136,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255, 
 255,128,128,128,128,128,128,128,128,128,128,191,160,160,160,160, 
 144,143,128,128,191,162,162,162,160,128,128,191,160,160,160,160, 
 128,128,128,128,128,128,128,128,128,128,128,255,128,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,128,128,128,159,160, 
 160,160,159,128,128,128,128,128,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,255,128,128,128,128,128,128,128,143,143, 
 143,143,143,143,143,143,143,143,143,143,191,191,191,159,159,159, 
 143,143,143,135,135,135,130,130,128,128,128,128,128,128,128,255 
},
{
 255,  1,  1,  1,  1,129,145,161,193,249,193,161,145,129,  1,  1, 
   1,129,145,161,193,249,193,161,145,129,  1,  1,  1,129,145,161, 
 193,249,193,161,145,129,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,255, 
 255,192,192,192,192,192,196,194,193,207,193,194,196,192,192,192, 
 192,192,196,194,193,207,193,194,196,192,192,192,192,192,196,194, 
 193,207,193,194,196,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,255, 
 255,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  4,  2,254,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  4,  2, 
 130, 98, 28,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  4, 34, 34, 34,220,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255, 
 255,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8, 10,202, 43,234, 10,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,234, 43, 
  42, 42, 42,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,137, 74, 42, 42, 41,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255, 
 255,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128, 
 128,128,140,139,136,136,191,136,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,255,128,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,128,128,128,145,161, 
 161,161,158,128,128,128,128,128,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,255,128,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,128,128,159,162,162,162,156,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,255, 
 255,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  2,  2,  2,226, 26,  6,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,220, 34, 
  34, 34,220,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0, 28, 34, 34, 34,252,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255, 
 255,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,232, 40, 40, 40, 40, 
  72,136,  8,  8,235, 40, 40, 40, 40,  8,  8,232,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,201, 42, 
  42, 42,201,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8,  8,  8,  8,136,136, 
 136,136,136,136,136,136,136,136,138,138,234,233,232,200,200,200, 
 136,136,136,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255, 
 255,128,128,128,128,128,128,128,128,128,128,191,160,160,160,160, 
 144,143,128,128,191,162,162,162,160,128,128,191,160,160,160,160, 
 128,128,128,128,128,128,128,128,128,128,128,255,128,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,128,128,128,159,160, 
 160,160,159,128,128,128,128,128,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,255,128,128,128,128,128,128,128,143,143, 
 143,143,143,143,143,143,143,143,143,143,191,191,191,159,159,159, 
 143,143,143,135,135,135,130,130,128,128,128,128,128,128,128,255 
},
{
 255,  1,  1,  1,  1,129,145,161,193,249,193,161,145,129,  1,  1, 
   1,129,145,161,193,249,193,161,145,129,  1,  1,  1,129,145,161, 
 193,249,193,161,145,129,  1,  1,  1,129,145,161,193,249,193,161, 
 145,129,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,255, 
 255,192,192,192,192,192,196,194,193,207,193,194,196,192,192,192, 
 192,192,196,194,193,207,193,194,196,192,192,192,192,192,196,194, 
 193,207,193,194,196,192,192,192,192,192,196,194,193,207,193,194, 
 196,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,255, 
 255,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  4,  2,254,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  4,  2, 
 130, 98, 28,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  4, 34, 34, 34,220,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255, 
 255,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8, 10,202, 43,234, 10,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,234, 43, 
  42, 42, 42,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,137, 74, 42, 42, 41,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255, 
 255,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128, 
 128,128,140,139,136,136,191,136,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,255,128,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,128,128,128,145,161, 
 161,161,158,128,128,128,128,128,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,255,128,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,128,128,159,162,162,162,156,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,255, 
 255,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  2,  2,  2,226, 26,  6,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,220, 34, 
  34, 34,220,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0, 28, 34, 34, 34,252,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255, 
 255,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,232, 40, 40, 40, 40, 
  72,136,  8,  8,235, 40, 40, 40, 40,  8,  8,232,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,201, 42, 
  42, 42,201,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8,  8,  8,  8,136,136, 
 136,136,136,136,136,136,136,136,138,138,234,233,232,200,200,200, 
 136,136,136,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255, 
 255,128,128,128,128,128,128,128,128,128,128,191,160,160,160,160, 
 144,143,128,128,191,162,162,162,160,128,128,191,160,160,160,160, 
 128,128,128,128,128,128,128,128,128,128,128,255,128,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,128,128,128,159,160, 
 160,160,159,128,128,128,128,128,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,255,128,128,128,128,128,128,128,143,143, 
 143,143,143,143,143,143,143,143,143,143,191,191,191,159,159,159, 
 143,143,143,135,135,135,130,130,128,128,128,128,128,128,128,255 
},
{
 255,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,225, 17,  9,  9,  9,  9, 17,  1,225, 17,  9,  9,  9, 
   9, 17,225,  1,  1,249,137,137,137,137,113,  1,  1,249,137,137, 
 137,137,113,  1,  1,249,137,137,137,  9,  1,  1,225, 17,  9,  9, 
   9,  9, 17,  9,  9,  9,249,  9,  9,  9,  1,  1,253,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,255, 
 255,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,195,196,200,200,200,200,196,192,195,196,200,200,200, 
 200,196,195,192,192,207,192,192,192,195,204,192,192,207,192,192, 
 192,195,204,192,192,207,200,200,200,200,192,192,195,196,200,200, 
 200,200,196,192,192,192,207,192,192,192,192,192,205,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,255, 
 255,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  4,  2,254,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  4,  2, 
 130, 98, 28,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  4, 34, 34, 34,220,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255, 
 255,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8, 10,202, 43,234, 10,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,234, 43, 
  42, 42, 42,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,137, 74, 42, 42, 41,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255, 
 255,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128, 
 128,128,140,139,136,136,191,136,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,255,128,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,128,128,128,145,161, 
 161,161,158,128,128,128,128,128,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,255,128,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,128,128,159,162,162,162,156,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,255, 
 255,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  2,  2,  2,226, 26,  6,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,220, 34, 
  34, 34,220,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0, 28, 34, 34, 34,252,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255, 
 255,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,232, 40, 40, 40, 40, 
  72,136,  8,  8,235, 40, 40, 40, 40,  8,  8,232,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,201, 42, 
  42, 42,201,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8,  8,  8,  8,136,136, 
 136,136,136,136,136,136,136,136,138,138,234,233,232,200,200,200, 
 136,136,136,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255, 
 255,128,128,128,128,128,128,128,128,128,128,191,160,160,160,160, 
 144,143,128,128,191,162,162,162,160,128,128,191,160,160,160,160, 
 128,128,128,128,128,128,128,128,128,128,128,255,128,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,128,128,128,159,160, 
 160,160,159,128,128,128,128,128,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,255,128,128,128,128,128,128,128,143,143, 
 143,143,143,143,143,143,143,143,143,143,191,191,191,159,159,159, 
 143,143,143,135,135,135,130,130,128,128,128,128,128,128,128,255 
},
{
 255,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,249,  1,  1,  1, 
 249,  9, 49, 65,129,  1,  1,249,  1,  1,225, 17,  9,  9,  9,  9, 
  17,  1,225, 17,  9,  9,  9,  9, 17,225,  1,  1,249,137,137,137, 
 137,113,  1,  1,249,137,137,137,137,113,  1,  1,249,137,137,137, 
   9,  1,  1,225, 17,  9,  9,  9,  9, 17,  9,  9,  9,249,  9,  9, 
   9,  1,  1,253,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1, 
   1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,  1,255, 
 255,192,192,192,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,207,192,192,192, 
 207,192,192,192,193,198,200,207,192,192,195,196,200,200,200,200, 
 196,192,195,196,200,200,200,200,196,195,192,192,207,192,192,192, 
 195,204,192,192,207,192,192,192,195,204,192,192,207,200,200,200, 
 200,192,192,195,196,200,200,200,200,196,192,192,192,207,192,192, 
 192,192,192,205,192,192,192,192,192,192,192,192,192,192,192,192, 
 192,192,192,192,192,192,192,192,192,192,192,192,192,192,192,255, 
 255,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  4,  2,254,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  4,  2, 
 130, 98, 28,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  4, 34, 34, 34,220,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255, 
 255,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8, 10,202, 43,234, 10,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,234, 43, 
  42, 42, 42,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,137, 74, 42, 42, 41,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255, 
 255,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128, 
 128,128,140,139,136,136,191,136,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,255,128,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,128,128,128,145,161, 
 161,161,158,128,128,128,128,128,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,255,128,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,128,128,159,162,162,162,156,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,255, 
 255,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  2,  2,  2,226, 26,  6,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,220, 34, 
  34, 34,220,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,255,  0,  0,  0,  0,  0,  0,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0, 28, 34, 34, 34,252,  0,  0,  0, 
   0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,  0,255, 
 255,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,232, 40, 40, 40, 40, 
  72,136,  8,  8,235, 40, 40, 40, 40,  8,  8,232,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,201, 42, 
  42, 42,201,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8, 
   8,  8,  8,  8,  8,  8,255,  8,  8,  8,  8,  8,  8,  8,136,136, 
 136,136,136,136,136,136,136,136,138,138,234,233,232,200,200,200, 
 136,136,136,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,  8,255, 
 255,128,128,128,128,128,128,128,128,128,128,191,160,160,160,160, 
 144,143,128,128,191,162,162,162,160,128,128,191,160,160,160,160, 
 128,128,128,128,128,128,128,128,128,128,128,255,128,128,128,128, 
 128,128,128,128,128,128,128,128,128,128,128,128,128,128,159,160, 
 160,160,159,128,128,128,128,128,128,128,128,128,128,128,128,128, 
 128,128,128,128,128,128,255,128,128,128,128,128,128,128,143,143, 
 143,143,143,143,143,143,143,143,143,143,191,191,191,159,159,159, 
 143,143,143,135,135,135,130,130,128,128,128,128,128,128,128,255 
}};

unsigned int sifra[] = {1, 9, 6, 3, 11}; // dodata je i strelica

// Stanje FSM i flagovi
unsigned char state = 0;
unsigned char flag = 0;

// Promenljive za TS
unsigned int X, Y, x_vrednost, y_vrednost;

// Tajmer T1
unsigned int t1;
unsigned char pwm = 1, timeout_pir = 0;
unsigned int stoperica = 0;

//const unsigned int ADC_THRESHOLD = 900; 
const unsigned int AD_Xmin =220; 
const unsigned int AD_Xmax =3642;
const unsigned int AD_Ymin =520;
const unsigned int AD_Ymax =3450;

// Promenljive za skladistenje vrednosti ADC
unsigned int sirovi0, sirovi1, sirovi2;

#define DRIVE_A PORTCbits.RC13
#define DRIVE_B PORTCbits.RC14

// ************** 
// Prekidne rutine

// ADC
void __attribute__((__interrupt__)) _ADCInterrupt(void) 
{
	sirovi0 = ADCBUF0; 
	sirovi1 = ADCBUF1;
    sirovi2 = ADCBUF2;
    
    IFS0bits.ADIF = 0;
} 

// Tajmer T1
void __attribute__ ((__interrupt__)) _T1Interrupt(void)
{
	TMR1 = 0;
    t1++;
    stoperica++;
    if(t1 == 30000)
        timeout_pir = 1;
    if(t1 == 65535)
        t1 = 0;
	IFS0bits.T1IF = 0;
       
}

// UART
void __attribute__((__interrupt__)) _U1RXInterrupt(void) 
{
    IFS0bits.U1RXIF = 0;
    // Jos uvek ne koristim serijsku za slanje sa racunara
}

// **************


// Konfiguracija pinova za TS
void ConfigureTSPins(void)
{
	TRISCbits.TRISC13=0;
    TRISCbits.TRISC14=0;	
}

void TimerDelay(unsigned int vreme)
{
    stoperica = 0;
    while(stoperica < vreme);
}

// Kasnjenje realizovano obicnm petljom, trebalo bi zameniti tajmerom
void Delay(unsigned int N)
{
	unsigned int i;
	for(i=0;i<N;i++);
}

// Citanje pritisnutih vrednosti 
void Touch_Panel (void)
{
	DRIVE_A = 1; 
	DRIVE_B = 0; 
    LATCbits.LATC13=1;
    LATCbits.LATC14=0;

	Delay(500); 		
	x_vrednost = sirovi0; 	

    LATCbits.LATC13=0;
    LATCbits.LATC14=1;
	DRIVE_A = 0;  
	DRIVE_B = 1;

	Delay(500); 	
	y_vrednost = sirovi1;
    
    X = (x_vrednost - 161) * 0.03629;
	Y = ((y_vrednost - 500) * 0.020725);
}

// Ispisuje broj na GLCD
void Write_GLCD(unsigned int data)
{
    unsigned char temp;

    temp=data/1000;
    Glcd_PutChar(temp+'0');
    data=data-temp*1000;
    temp=data/100;
    Glcd_PutChar(temp+'0');
    data=data-temp*100;
    temp=data/10;
    Glcd_PutChar(temp+'0');
    data=data-temp*10;
    Glcd_PutChar(data+'0');
}

// *************
// Moje funkcije

char PritisnutBroj(int x, int y)
{
    if((x >= 1 && x <= 42) && (y >= 37 && y <= 47))
        return 1;
    else if((x >= 44 && x <= 85) && (y >= 37 && y <= 47))
        return 2;
    else if((x >= 87 && x <= 126) && (y >= 37 && y <= 47))
        return 3;
    else if((x >= 1 && x <= 42) && (y >= 25 && y <= 35))
        return 4;
    else if((x >= 44 && x <= 85) && (y >= 25 && y <= 35))
        return 5;
    else if((x >= 87 && x <= 126) && (y >= 25 && y <= 35))
        return 6;
    else if((x >= 1 && x <= 42) && (y >= 13 && y <= 23))
        return 7;
    else if((x >= 44 && x <= 85) && (y >= 13 && y <= 23))
        return 8;
    else if((x >= 87 && x <= 126) && (y >= 13 && y <= 23))
        return 9;
    else if((x >= 44 && x <= 85) && (y >= 1 && y <= 11))
        return 0;
    else if((x >= 1 && x <= 42) && (y >= 1 && y <= 11))
        return 10; // del
    else if((x >= 87 && x <= 126) && (y >= 1 && y <= 11))
        return 11; // strelica
    else
        return -1; // Ako nije nijedna od prethodnih opcija
}

unsigned char UnosSifre()
{
    unsigned char count = 0;
    unsigned char unos[5];
    char broj;
    
    while(count < 5)
    {
        GLCD_DisplayPicture(keypad[count]);
        Touch_Panel();
        Delay(65535);
        broj = PritisnutBroj(X, Y);
        if(broj != -1)
        {
            // Treba pripaziti da se ne pritiska strelica ranije
            if(count != 4 && broj == 11)
                return 0;
            if(broj != 10)
                unos[count++] = broj;
            else
            {
                if(count != 0)
                    count--;
            }
        }
    }
    
    for(count = 0; count < 5; count++)
    {
        if(sifra[count] != unos[count])
            return 0;
    }
    
    return 1;
}
// *************

int main(int argc, char** argv)
{
    
    //unsigned char flag = 0, val;
    
    // ************
    // Inicijalizacije
    
    TRISAbits.TRISA11 = 0; // A11 ce biti pin koji kontrolise buzzer
    TRISDbits.TRISD9 = 1; // Taster vezna za D9 ce glumiti PIR senzor
    TRISDbits.TRISD8 = 0; // D8 ce biti svetlo
    LATDbits.LATD8 = 1;
    
    ConfigureLCDPins();
	ConfigureTSPins();

	GLCD_LcdInit();
	GLCD_ClrScr();
	
	ADCinit();
	ConfigureADCPins();
	ADCON1bits.ADON=1;
    // ************
    
    
    while(1)
    {
        switch(state)
        {
            case 0:
                
                state = 0; // Inicijalno nula, ako se nista ne dogodi
                //Write_GLCD(t1);
                //Delay(65535);
                //Delay(65535);
                //Delay(65535);
                //GLCD_ClrScr();
                
                
                //GLCD_DisplayPicture(keypad[0]);
                Touch_Panel();
                Delay(65535);
                
                if(PritisnutBroj(X, Y) == 11)
                {    
                    state = 1;
                    GLCD_DisplayPicture(keypad[5]);
                    Delay(65535);
                }
                else if(PORTDbits.RD9)
                    state = 2;
                else if(sirovi2 > PRAG)
                {
                    RS232_putstr("Pistace");
                    state = 3;
                    flag = 1;
                }
                break;
            
            case 1:
                if(UnosSifre())
                {    
                    state = 0;
                    GLCD_DisplayPicture(keypad[5]);
                    Delay(65535);
                }
                else
                {    
                    state = 3;
                    GLCD_DisplayPicture(keypad[6]);
                    Delay(65535);
                }
                break;
                
            case 2:
                LATDbits.LATD8 = 1;
                RS232_putstr("Isteklo je vreme");
                if(timeout_pir == 1)
                {
                    state = 0;
                }
                else
                    state = 2;
                break;
                
            case 3:
                
                LATAbits.LATA11 = 1;
                Delay(500);
                LATAbits.LATA11 = 0;
                Delay(100);
                
                if(flag == 1)
                {
                    RS232_putstr("Visok nivo CO2!");
                    flag = 0;
                    state = 3; // Ovo je samo trenutno
                }
                else
                    state = 3;
                break;
        }
    }
    
    
    return (EXIT_SUCCESS);
}

